# Release Notes - v1.1.6

**リリース日**: 2026年2月6日

---

## 🎯 緊急修正リリース

v1.1.6では、ユーザーから報告された**通信エラー**を根本的に解決しました。

---

## 🐛 修正された問題

### 「Could not establish connection」エラー

**報告された現象**:
```
❌ Content Scriptと通信できません。
❌ Could not establish connection. Receiving end does not exist.
❌ All 3 attempts failed for getConversations
```

**発生条件**:
- 拡張機能をインストール後、ChatGPTページをリロードしていない
- 既に開いているChatGPTページでポップアップを開いた
- Content Scriptが注入されていない状態

**影響**:
- チャット履歴が表示されない
- メモリが表示されない
- 削除機能が使えない

---

## ✨ 実装した解決策

### Content Scriptの自動注入

**新機能**:
Content Scriptが読み込まれていない場合、**自動的に注入**します。

**処理フロー**:

```
ポップアップを開く
  ↓
Content Scriptの存在を確認（Ping: 100ms）
  ↓
【ロード済みの場合】
  ✅ そのまま処理を続行（+10-20ms）
  
【未ロード時】
  ⚠️ Content Scriptを自動注入（+600ms）
  ✅ 処理を続行
```

**Before (v1.1.5)**:
```
ポップアップを開く
  ↓
Content Scriptとの通信を試みる
  ↓
3回リトライ（1秒、2秒、4秒待機）
  ↓
❌ エラー表示（約7秒後）
  ↓
ユーザーがF5でリロード
  ↓
もう一度ポップアップを開く

合計: 約10-15秒
```

**After (v1.1.6)**:
```
ポップアップを開く
  ↓
Content Scriptの存在確認（100ms）
  ↓
未ロードを検出
  ↓
自動注入（500ms）
  ↓
✅ 処理を続行

合計: 約0.6秒
```

**改善**: **10-15秒 → 0.6秒**（約15-25倍高速）

---

## 🚀 主な改善点

### 1. エラーが発生しない

**Before**: 
- エラーメッセージが表示される
- ユーザーがF5でリロードする必要がある

**After**: 
- ✅ 自動的に修復される
- ✅ エラーメッセージが表示されない

---

### 2. ページリロード不要

**Before**: 
- 拡張機能をインストール後、ChatGPTをリロードする必要がある

**After**: 
- ✅ リロード不要
- ✅ すぐに使える

---

### 3. より明確なエラーメッセージ

万が一、動的注入も失敗した場合：

```
⚠️ Content Scriptの読み込みに失敗しました。

【解決方法】
1. ChatGPTのページで「F5」キーを押す
2. もう一度拡張機能を開く

それでも解決しない場合：
- すべてのChatGPTタブを閉じる
- 新しいタブでChatGPTを開く
```

---

## 📊 パフォーマンス影響

### 通常時（Content Scriptロード済み）

| 項目 | v1.1.5 | v1.1.6 | 変化 |
|------|--------|--------|------|
| ポップアップ表示 | 0.5秒 | 0.52秒 | +0.02秒 |
| 削除処理（50件） | 40秒 | 40秒 | 変化なし |

**影響**: ほぼ無視できる（+20ms）

---

### Content Script未ロード時

| 項目 | v1.1.5 | v1.1.6 | 変化 |
|------|--------|--------|------|
| エラー発生までの時間 | 約7秒 | - | なし |
| 自動修復時間 | - | 0.6秒 | ✅ 新機能 |
| ユーザーのリロード操作 | 3-8秒 | 不要 | ✅ 削減 |
| **合計** | **10-15秒** | **0.6秒** | ✅ **約25倍高速** |

---

## 🔧 技術的な詳細

### 新しいメソッド

```typescript
// api-client.ts
private async ensureContentScriptLoaded(tabId: number): Promise<void> {
  // 1. Pingで存在確認（100msタイムアウト）
  // 2. 未ロード時は動的注入
  // 3. 500ms待機
}
```

### manifest.json の変更

```json
{
  "permissions": [
    "storage",
    "tabs",
    "scripting"  // ← 追加
  ]
}
```

**scripting permission**: Content Scriptを動的に注入するために必要

---

## 🧪 テスト項目

### 必須テスト

#### テスト1: 通常ケース（Content Scriptロード済み）

1. ChatGPT（https://chatgpt.com）を開く
2. **F5でリロード**
3. 拡張機能のポップアップを開く
4. チャット履歴が表示される

**期待される結果**:
- ✅ 通常通り動作
- ✅ エラーなし
- ✅ 表示速度は変わらず（+20ms程度）

---

#### テスト2: Content Script未ロード（重要！）

1. ChatGPT（https://chatgpt.com）を開く
2. **リロードせずに**拡張機能のポップアップを開く
3. （v1.1.5ではエラーが発生していた）

**期待される結果**:
- ✅ エラーが表示されない
- ✅ 約0.6秒後にチャット履歴が表示される
- ✅ 通常通り削除できる

**コンソールログ（期待）**:
```
⚠️ Content Script not loaded, injecting...
✅ Content Script injected successfully
📡 Fetching conversations (max 50)...
✅ Conversations loaded: 50
```

---

#### テスト3: 拡張機能の新規インストール

1. 拡張機能を削除
2. ChatGPTを開いたままにする
3. 拡張機能を再インストール
4. **リロードせずに**ポップアップを開く

**期待される結果**:
- ✅ エラーが表示されない
- ✅ 自動的に動作する

---

#### テスト4: 複数回のポップアップ開閉

1. ChatGPTを開く
2. ポップアップを開く（1回目）
3. ポップアップを閉じる
4. ポップアップを開く（2回目）

**期待される結果**:
- ✅ 1回目: Content Scriptを注入（+600ms）
- ✅ 2回目: 既にロード済み（+20ms）

---

## 🎉 まとめ

v1.1.6では、報告された通信エラーを**根本的に解決**しました。

### 主な改善点

1. ✅ **エラーが発生しない**: 自動修復機能
2. ✅ **リロード不要**: すぐに使える
3. ✅ **高速**: 10-15秒 → 0.6秒（約25倍高速）
4. ✅ **パフォーマンス影響最小**: 通常時+20ms

### ユーザー体験

- Before: エラー → F5でリロード → 再度開く
- After: **自動的に動作** → ユーザー操作不要

---

## 📥 インストール

### 新規インストール

1. [Releases](https://github.com/Masahiro-kokoro/chatgpt-bulk-deleter/releases)から`chatgpt-bulk-deleter-v1.1.6.zip`をダウンロード
2. 解凍する
3. Chrome拡張機能ページで「パッケージ化されていない拡張機能を読み込む」をクリック
4. 解凍したフォルダを選択
5. **リロード不要で使用可能**

### v1.1.5からのアップデート

既存のバージョンをアンインストールしてから、上記の手順でインストールしてください。

---

**Enjoy error-free bulk deletion! 🎉**
